<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <meta name="description" content="Sistema de controle de separação de estoque com cronômetro em tempo real">
    <meta name="theme-color" content="#0a0a0a">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="RepositionFlow">
    <title>RepositionFlow - Sistema de Separação Inteligente</title>
    <link rel="stylesheet" href="styles.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
</head>
<body>
    <!-- ==========================================
         TELA DE SELEÇÃO DE ROLE
         ========================================== -->
    <div id="roleSelectionScreen" class="login-container">
        <div class="login-card">
            <div class="login-header">
                <div class="login-logo">📦</div>
                <h1 class="login-title text-gradient">RepositionFlow</h1>
                <p class="login-subtitle">Sistema de Separação Inteligente</p>
            </div>
            <form id="roleForm" autocomplete="off">
                <div class="form-group">
                    <label for="userRole">Selecione sua Função</label>
                    <select id="userRole" required autocomplete="off">
                        <option value="">Escolha sua função...</option>
                        <option value="atendente">👤 Atendente</option>
                        <option value="separador">📋 Separador</option>
                        <option value="admin">👑 Administrador</option>
                    </select>
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%; margin-top: 1rem;">
                    Continuar →
                </button>
            </form>
        </div>
    </div>

    <!-- ==========================================
         TELA DE LOGIN ADMIN
         ========================================== -->
    <div id="adminLoginScreen" class="login-container hidden">
        <div class="login-card">
            <div class="login-header">
                <div class="login-logo">👑</div>
                <h1 class="login-title">Acesso Administrativo</h1>
                <p class="login-subtitle">Área restrita - Credenciais necessárias</p>
            </div>
            <form id="adminLoginForm" autocomplete="off">
                <div class="form-group">
                    <label for="adminUsername">Usuário</label>
                    <input type="text" id="adminUsername" placeholder="Digite o usuário" required autocomplete="off">
                </div>
                <div class="form-group">
                    <label for="adminPassword">Senha</label>
                    <input type="password" id="adminPassword" placeholder="Digite a senha" required autocomplete="off">
                </div>
                <div id="adminLoginError" class="hidden" style="color: var(--status-danger); margin-bottom: 1rem; text-align: center; font-size: 0.9rem;"></div>
                <div style="display: flex; gap: 1rem;">
                    <button type="button" class="btn btn-ghost" id="btnBackToRole" style="flex: 1;">
                        ← Voltar
                    </button>
                    <button type="submit" class="btn btn-primary" style="flex: 2;">
                        Entrar
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- ==========================================
         APLICAÇÃO PRINCIPAL
         ========================================== -->
    <div id="mainApp" class="hidden">
        <!-- Header -->
        <header>
            <div class="header-content">
                <a href="#" class="logo">
                    📦 RepositionFlow
                </a>
                <nav class="nav-links">
                    <button class="btn btn-ghost nav-btn active" data-view="dashboard">
                        Dashboard
                    </button>
                    <button class="btn btn-ghost nav-btn hidden" data-view="nova-requisicao" id="novaTarefaBtn">
                        Nova Requisição
                    </button>
                    <button class="btn btn-ghost nav-btn hidden" data-view="metricas" id="metricasBtn">
                        Métricas
                    </button>
                    <button class="btn btn-ghost nav-btn hidden" data-view="admin-dashboard" id="adminDashboardBtn">
                        Admin Dashboard
                    </button>
                </nav>
                <div class="user-info">
                    <span class="user-badge" id="userDisplay"></span>
                    <button class="btn btn-danger btn-sm" id="btnLogout">Sair</button>
                </div>
            </div>
        </header>

        <div class="container">
            <!-- ==========================================
                 VIEW: DASHBOARD (Todos)
                 ========================================== -->
            <div id="dashboard" class="view">
                <div class="dashboard-header">
                    <h1 class="dashboard-title">Dashboard</h1>
                    <p class="dashboard-subtitle">Visão geral das tarefas de separação</p>
                </div>

                <!-- Filtros -->
                <div class="glass-card" style="margin-bottom: 2rem;">
                    <div style="display: flex; gap: 1rem; flex-wrap: wrap; margin-bottom: 1rem;">
                        <select id="filterStatus" class="btn btn-secondary" style="flex: 1; min-width: 200px;">
                            <option value="">Todos os Status</option>
                            <option value="PENDENTE">🟡 Pendente</option>
                            <option value="EM_SEPARACAO">🔵 Em Separação</option>
                            <option value="CONCLUIDO">🟢 Concluído</option>
                            <option value="CANCELADA">🔴 Cancelada</option>
                        </select>
                        <input type="text" id="filterAtendente" placeholder="Buscar por atendente..." style="flex: 2; min-width: 250px;" autocomplete="off">
                        <button id="btnRefresh" class="btn btn-primary">
                            🔄 Atualizar
                        </button>
                    </div>
                    <!-- Filtros de Data -->
                    <div style="display: flex; gap: 1rem; flex-wrap: wrap; align-items: center;">
                        <div style="display: flex; align-items: center; gap: 0.5rem; flex: 1; min-width: 200px;">
                            <label for="filterDataInicio" style="white-space: nowrap; color: var(--text-secondary); font-size: 0.9rem;">📅 De:</label>
                            <input type="date" id="filterDataInicio" style="flex: 1;">
                        </div>
                        <div style="display: flex; align-items: center; gap: 0.5rem; flex: 1; min-width: 200px;">
                            <label for="filterDataFim" style="white-space: nowrap; color: var(--text-secondary); font-size: 0.9rem;">📅 Até:</label>
                            <input type="date" id="filterDataFim" style="flex: 1;">
                        </div>
                        <button id="btnClearDates" class="btn btn-ghost" style="white-space: nowrap;">
                            🗑️ Limpar Datas
                        </button>
                    </div>
                </div>

                <!-- Stats Cards -->
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon orange">⏳</div>
                        <div class="stat-label">Pendentes</div>
                        <div class="stat-value" id="statPendente">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon blue">🔄</div>
                        <div class="stat-label">Em Separação</div>
                        <div class="stat-value" id="statEmSeparacao">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon green">✓</div>
                        <div class="stat-label">Concluídas</div>
                        <div class="stat-value" id="statConcluido">0</div>
                    </div>
                </div>

                <!-- Task List -->
                <div id="taskList" class="grid grid-cols-1" style="gap: 1.5rem;">
                    <div class="glass-card text-center">
                        <p style="color: var(--text-secondary);">Nenhuma tarefa encontrada</p>
                    </div>
                </div>
            </div>

            <!-- ==========================================
                 VIEW: NOVA REQUISIÇÃO (Atendente)
                 ========================================== -->
            <div id="nova-requisicao" class="view hidden">
                <div class="dashboard-header">
                    <h1 class="dashboard-title">Nova Requisição</h1>
                    <p class="dashboard-subtitle">Envie uma planilha de reposição</p>
                </div>

                <div class="glass-card" style="max-width: 800px; margin: 0 auto;">
                    <form id="uploadForm" autocomplete="off">
                        <div class="form-group">
                            <label for="nomeAtendente">Nome do Atendente</label>
                            <input type="text" id="nomeAtendente" placeholder="Seu nome" required autocomplete="off">
                        </div>
                        <div class="form-group">
                            <label for="prioridade">Prioridade</label>
                            <select id="prioridade">
                                <option value="Baixa">🟢 Baixa</option>
                                <option value="Média" selected>🟡 Média</option>
                                <option value="Alta">🔴 Alta</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="observacoes">Observações (opcional)</label>
                            <textarea id="observacoes" placeholder="Instruções especiais, localização preferencial, urgências..." rows="3" style="resize: vertical; min-height: 80px;"></textarea>
                            <small style="color: var(--text-secondary); display: block; margin-top: 0.5rem;">
                                Ex: "Priorizar itens da coluna A", "Cliente aguardando", etc.
                            </small>
                        </div>
                        <div class="form-group">
                            <label for="planilhaFile">Planilha Excel (.xlsx)</label>
                            <input type="file" id="planilhaFile" accept=".xlsx,.xls" required>
                            <small style="color: var(--text-secondary); display: block; margin-top: 0.5rem;">
                                A planilha deve conter: Cod Material, Desc Material, pegar
                            </small>
                        </div>
                        <button type="submit" class="btn btn-primary" style="width: 100%; margin-top: 1rem;">
                            📤 Enviar Requisição
                        </button>
                    </form>
                </div>
            </div>

            <!-- ==========================================
                 VIEW: MÉTRICAS (Todos)
                 ========================================== -->
            <div id="metricas" class="view hidden">
                <div class="dashboard-header">
                    <h1 class="dashboard-title">Métricas</h1>
                    <p class="dashboard-subtitle">Análise de desempenho e estatísticas</p>
                </div>

                <!-- Filtro de Período -->
                <div class="glass-card" style="margin-bottom: 2rem;">
                    <label style="margin-bottom: 0.5rem; display: block;">Período</label>
                    <select id="metricsFilter" class="btn btn-secondary">
                        <option value="dia">Últimas 24 horas</option>
                        <option value="semana">Última semana</option>
                        <option value="mes">Último mês</option>
                        <option value="">Todo o período</option>
                    </select>
                </div>

                <!-- Stats Cards -->
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon green">📊</div>
                        <div class="stat-label">Total de Tarefas</div>
                        <div class="stat-value" id="metricTotalTarefas">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon blue">⏱️</div>
                        <div class="stat-label">Tempo Médio</div>
                        <div class="stat-value" id="metricTempoMedio">00:00</div>
                    </div>
                </div>

                <!-- Ranking de Separadores -->
                <div class="glass-card" style="margin-top: 2rem;">
                    <h3 style="margin-bottom: 1.5rem;">🏆 Ranking de Separadores</h3>
                    <div id="rankingSeparadores">
                        <p style="color: var(--text-secondary); text-align: center;">Nenhum dado disponível</p>
                    </div>
                </div>

                <!-- Estatísticas Detalhadas -->
                <div class="grid grid-cols-2" style="margin-top: 2rem;">
                    <div class="glass-card">
                        <h3 style="margin-bottom: 1rem;">Por Atendente</h3>
                        <div id="statsPorAtendente">
                            <p style="color: var(--text-secondary);">Carregando...</p>
                        </div>
                    </div>
                    <div class="glass-card">
                        <h3 style="margin-bottom: 1rem;">Por Separador</h3>
                        <div id="statsPorSeparador">
                            <p style="color: var(--text-secondary);">Carregando...</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ==========================================
                 VIEW: ADMIN DASHBOARD (Admin apenas)
                 ========================================== -->
            <div id="admin-dashboard" class="view hidden">
                <div class="dashboard-header">
                    <h1 class="dashboard-title">
                        <span class="text-gradient">Admin Dashboard</span>
                    </h1>
                    <p class="dashboard-subtitle">Análise completa de desempenho dos colaboradores</p>
                </div>

                <!-- Stats Cards Principais -->
                <div class="stats-grid" style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));">
                    <div class="stat-card">
                        <div class="stat-icon green">📋</div>
                        <div class="stat-label">Total de Tarefas</div>
                        <div class="stat-value" id="adminStatTotal">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon orange">⏳</div>
                        <div class="stat-label">Pendentes</div>
                        <div class="stat-value" id="adminStatPendentes">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon blue">🔄</div>
                        <div class="stat-label">Em Separação</div>
                        <div class="stat-value" id="adminStatEmSeparacao">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon green">✓</div>
                        <div class="stat-label">Concluídas</div>
                        <div class="stat-value" id="adminStatConcluidas">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon blue">📦</div>
                        <div class="stat-label">Total de Itens</div>
                        <div class="stat-value" id="adminStatItens">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon green">⏱️</div>
                        <div class="stat-label">Tempo Médio</div>
                        <div class="stat-value" id="adminStatTempoMedio" style="font-size: 1.8rem;">00:00</div>
                    </div>
                </div>

                <!-- Gráficos -->
                <div class="charts-grid">
                    <div class="chart-container">
                        <div class="chart-header">
                            <h3 class="chart-title">📊 Top 5 Separadores - Total de Separações</h3>
                        </div>
                        <canvas id="chartSeparadores"></canvas>
                    </div>
                    <div class="chart-container">
                        <div class="chart-header">
                            <h3 class="chart-title">📦 Top 5 Separadores - Itens Separados</h3>
                        </div>
                        <canvas id="chartItensSeparadores"></canvas>
                    </div>
                    <div class="chart-container">
                        <div class="chart-header">
                            <h3 class="chart-title">⏱️ Tempo Médio por Separador</h3>
                        </div>
                        <canvas id="chartTemposSeparadores"></canvas>
                    </div>
                    <div class="chart-container">
                        <div class="chart-header">
                            <h3 class="chart-title">👥 Top 5 Atendentes - Listas Enviadas</h3>
                        </div>
                        <canvas id="chartAtendentes"></canvas>
                    </div>
                    <div class="chart-container">
                        <div class="chart-header">
                            <h3 class="chart-title">📦 Total de Itens por Atendente</h3>
                        </div>
                        <canvas id="chartItensAtendentes"></canvas>
                    </div>
                </div>

                <!-- Tabelas Detalhadas -->
                <div class="grid grid-cols-2" style="margin-top: 2rem;">
                    <div class="glass-card">
                        <h3 style="margin-bottom: 1.5rem; color: var(--accent-green);">🏆 Separadores - Ranking por Eficiência</h3>
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>#</th>
                                        <th>Nome</th>
                                        <th>Separações</th>
                                        <th>Itens</th>
                                        <th>Eficiência</th>
                                        <th>Tempo Médio</th>
                                    </tr>
                                </thead>
                                <tbody id="tableSeparadores">
                                    <tr>
                                        <td colspan="6" style="text-align: center; color: var(--text-secondary);">
                                            Carregando...
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div class="glass-card">
                        <h3 style="margin-bottom: 1.5rem; color: var(--accent-blue);">👤 Atendentes - Ranking Completo</h3>
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>#</th>
                                        <th>Nome</th>
                                        <th>Listas</th>
                                        <th>Itens</th>
                                        <th>Concluídas</th>
                                    </tr>
                                </thead>
                                <tbody id="tableAtendentes">
                                    <tr>
                                        <td colspan="5" style="text-align: center; color: var(--text-secondary);">
                                            Carregando...
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ==========================================
         MODAL: DETALHES DA TAREFA
         ========================================== -->
    <div id="taskModal" class="modal">
        <div class="modal-content" style="max-width: 1000px;">
            <div class="modal-header">
                <h2 id="modalTaskTitle">Detalhes da Tarefa</h2>
                <button class="modal-close" id="closeModal">×</button>
            </div>
            <div class="modal-body" id="modalTaskContent">
                <!-- Conteúdo será inserido via JavaScript -->
            </div>
        </div>
    </div>

    <!-- ==========================================
         MODAL: PREVIEW E EDIÇÃO DA PLANILHA
         ========================================== -->
    <div id="previewModal" class="modal">
        <div class="modal-content" style="max-width: 1400px; max-height: 90vh;">
            <div class="modal-header">
                <h2>📋 Revisar e Editar Planilha</h2>
                <button class="modal-close" id="closePreviewModal">×</button>
            </div>
            <div class="modal-body">
                <div class="glass-card" style="margin-bottom: 1.5rem; padding: 1rem;">
                    <p style="color: var(--text-secondary); margin-bottom: 0.5rem;">
                        ℹ️ Revise os itens abaixo e <strong>preencha a quantidade desejada</strong> para cada produto.
                    </p>
                    <p style="color: var(--status-warning); font-size: 0.9rem; margin-bottom: 0.5rem;">
                        ⚠️ A <strong>"Qtd a Pegar"</strong> não pode exceder o <strong>"Total Disponível"</strong>
                    </p>
                    <p style="color: var(--text-muted); font-size: 0.85rem; margin: 0;">
                        💡 Campos com <span style="color: var(--status-warning);">✏️</span> precisam ser preenchidos. Pelo menos um item deve ter quantidade maior que zero.
                    </p>
                </div>

                <!-- Resumo da Planilha -->
                <div class="stats-grid" style="margin-bottom: 1.5rem;">
                    <div class="stat-card">
                        <div class="stat-icon blue">📦</div>
                        <div class="stat-info">
                            <span class="stat-label">Total de SKUs</span>
                            <span class="stat-value" id="previewTotalSkus">0</span>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon green">🔢</div>
                        <div class="stat-info">
                            <span class="stat-label">Total de Itens</span>
                            <span class="stat-value" id="previewTotalItems">0</span>
                        </div>
                    </div>
                </div>

                <!-- Tabela de Itens Editável -->
                <div style="overflow-x: auto; max-height: 50vh; overflow-y: auto; border: 1px solid var(--border-color); border-radius: 8px; background: var(--bg-secondary);">
                    <table class="preview-table" id="previewTable">
                        <thead style="position: sticky; top: 0; background: var(--bg-primary); z-index: 10;">
                            <tr>
                                <th style="width: 120px;">Cód. Material</th>
                                <th style="min-width: 250px;">Descrição</th>
                                <th style="width: 120px;">Total Disponível</th>
                                <th style="width: 140px;">Qtd a Pegar</th>
                                <th style="min-width: 200px;">Localização</th>
                                <th style="width: 80px;">Status</th>
                                <th style="width: 60px;">Ações</th>
                            </tr>
                        </thead>
                        <tbody id="previewTableBody">
                            <!-- Itens serão inseridos aqui via JavaScript -->
                        </tbody>
                    </table>
                </div>

                <!-- Botões de Ação -->
                <div style="display: flex; gap: 1rem; margin-top: 1.5rem; justify-content: flex-end;">
                    <button class="btn btn-ghost" id="btnCancelPreview">
                        ❌ Cancelar
                    </button>
                    <button class="btn btn-primary" id="btnConfirmPreview">
                        ✅ Confirmar e Criar Tarefa
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast de Notificações -->
    <div id="toastContainer" style="position: fixed; bottom: 2rem; right: 2rem; z-index: 9999;"></div>

    <!-- Config DEVE vir antes do app.js -->
    <script src="config.js"></script>
    <script src="app.js"></script>
</body>
</html>
